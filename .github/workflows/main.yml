# This is the name of your pipeline
name: DevOps Project CI/CD Pipeline

# This tells GitHub WHEN to run the pipeline
on:
  # 1. Run it automatically on every push to the "main" branch
  push:
    branches: [ main ]
  # 2. Also allow us to run it manually from the "Actions" tab
  workflow_dispatch:

# This section defines the "job" or the steps to run
jobs:
  build-and-deploy:
    # Use a standard Ubuntu Linux machine to run our job
    runs-on: ubuntu-latest

    # These are the step-by-step tasks
    steps:
    # --- CHECKOUT & LOGIN (SETUP) ---

    # 1. Check out our repository code so the pipeline can use it
    - name: 'Checkout GitHub Action'
      uses: actions/checkout@v4

    # 2. Log in to Azure using our "master key" secret
    - name: 'Login to Azure'
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    # 3. Log in to the Azure Container Registry (ACR)
    # (This uses the login from Step 2)
    - name: 'Login to ACR'
      uses: azure/docker-login@v1
      with:
        login-server: ${{ secrets.ACR_LOGIN_SERVER }}

    # --- BUILD (PHASE 2) ---

    # 4. Build and push our Docker image to the ACR
    - name: 'Build and push Docker image to ACR'
      run: |
        docker build . -t ${{ secrets.ACR_LOGIN_SERVER }}/my-web-app:${{ github.sha }}
        docker push ${{ secrets.ACR_LOGIN_SERVER }}/my-web-app:${{ github.sha }}
      # Note: We use "${{ github.sha }}" as the tag. This is the unique
      # commit ID. It's better than "latest" because it's specific.

    # --- DEPLOY (PHASE 4) ---

    # 5. VERY IMPORTANT: Update the Kubernetes manifest
    # This "sed" command finds the placeholder image in our deployment.yaml
    # and replaces it with the REAL image we just built.
    - name: 'Update image tag in Kubernetes manifest'
      run: |
        sed -i 's|image: <YOUR_ACR_LOGIN_SERVER>/my-web-app:latest|image: ${{ secrets.ACR_LOGIN_SERVER }}/my-web-app:${{ github.sha }}|' kubernetes/deployment.yaml

    # 6. Set up kubectl to talk to our AKS cluster
    - name: 'Set up AKS context'
      uses: azure/aks-set-context@v3
      with:
        resource-group: 'devops-project-rg'   # From our Terraform file
        cluster-name: 'devops-project-aks' # From our Terraform file

    # 7. Install Ansible on the runner
    - name: 'Install Ansible'
      run: |
        sudo apt-get update
        sudo apt-get install -y ansible

    # 8. Run our Ansible playbook to deploy the app
    - name: 'Run Ansible Playbook to deploy'
      run: ansible-playbook ansible/playbook.yaml



